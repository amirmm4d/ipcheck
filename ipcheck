#!/usr/bin/env bash
#
# ipcheck - Advanced, parallel IP reputation checker v2.2.8
#
# This is the main entry point. All functions are loaded from lib/ directory.

set -euo pipefail

# Version
IPCHECK_VERSION="2.2.8"

# Determine script directory for loading lib files
# If installed system-wide, use /usr/local/lib/ipcheck, otherwise use local lib/
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
SCRIPT_PATH="${BASH_SOURCE[0]}"
# Resolve symlinks to get actual path
if command -v readlink >/dev/null 2>&1; then
    SCRIPT_REAL_PATH=$(readlink -f "$SCRIPT_PATH" 2>/dev/null || readlink "$SCRIPT_PATH" 2>/dev/null || echo "$SCRIPT_PATH")
else
    SCRIPT_REAL_PATH="$SCRIPT_PATH"
fi

# Check if installed system-wide
if [[ "$SCRIPT_REAL_PATH" == "/usr/local/bin/ipcheck" ]] || [[ "$SCRIPT_PATH" == "/usr/local/bin/ipcheck" ]]; then
    if [[ -d "/usr/local/lib/ipcheck" ]]; then
        LIB_DIR="/usr/local/lib/ipcheck"
    else
        # Fallback to local lib if system lib doesn't exist
        LIB_DIR="$SCRIPT_DIR/lib"
    fi
else
    # Running from local directory
    LIB_DIR="$SCRIPT_DIR/lib"
fi

# Color setup
if [[ -t 1 ]]; then
    GREEN=$(tput setaf 2)
    RED=$(tput setaf 1)
    YELLOW=$(tput setaf 3)
    BLUE=$(tput setaf 4)
    NC=$(tput sgr0) # No Color
else
    GREEN="" RED="" YELLOW="" BLUE="" NC=""
fi

# Initialize status directory
STATUS_DIR=$(mktemp -d)
trap 'rm -rf -- "$STATUS_DIR"' EXIT

# Global variables for options
LOG_DIR=""
LOG_FORMAT="txt"  # txt or json
ASK_VPN_INSTALL=false  # Ask interactively after server check
AUTO_VPN_TYPE=""       # Auto-install VPN type (singbox, xray, v2ray, shadowsocks, openvpn, cisco)
ENABLE_SCORING=false
ENABLE_CDN_CHECK=false
ENABLE_ROUTING_CHECK=false
ENABLE_PORT_SCAN=false
ENABLE_REALITY_TEST=false
ENABLE_USAGE_HISTORY=false
ENABLE_SUGGESTIONS=false

# Results storage for scoring and reports
declare -A SCORE_METRICS
declare -A CDN_RESULTS
declare -A ROUTING_RESULTS
declare -A PORT_RESULTS
declare -A REALITY_RESULTS
declare -A USAGE_RESULTS

# Load all library files
# shellcheck source=lib/core.sh
source "$LIB_DIR/core.sh"
# shellcheck source=lib/logging.sh
source "$LIB_DIR/logging.sh"
# shellcheck source=lib/api_calls.sh
source "$LIB_DIR/api_calls.sh"
# shellcheck source=lib/api_extended.sh
source "$LIB_DIR/api_extended.sh"
# shellcheck source=lib/scoring.sh
source "$LIB_DIR/scoring.sh"
# shellcheck source=lib/cdn.sh
source "$LIB_DIR/cdn.sh"
# shellcheck source=lib/routing.sh
source "$LIB_DIR/routing.sh"
# shellcheck source=lib/port_scan.sh
source "$LIB_DIR/port_scan.sh"
# shellcheck source=lib/reality.sh
source "$LIB_DIR/reality.sh"
# shellcheck source=lib/usage.sh
source "$LIB_DIR/usage.sh"
# shellcheck source=lib/suggestions.sh
source "$LIB_DIR/suggestions.sh"
# shellcheck source=lib/reporting.sh
source "$LIB_DIR/reporting.sh"
# shellcheck source=lib/menu_main.sh
source "$LIB_DIR/menu_main.sh"
# shellcheck source=lib/menu_ip_check.sh
source "$LIB_DIR/menu_ip_check.sh"
# shellcheck source=lib/menu_vpn.sh
source "$LIB_DIR/menu_vpn.sh"
# shellcheck source=lib/menu_process.sh
source "$LIB_DIR/menu_process.sh"
# shellcheck source=lib/main_logic.sh
source "$LIB_DIR/main_logic.sh"
# shellcheck source=lib/vpn.sh
source "$LIB_DIR/vpn.sh"

# Main entry point
main "$@"

